# Easy VK Tunnel 2.0

Вторая версия bash-скрипта для лёгкого создания VLESS-конфигурации с использованием [vk-tunnel](https://github.com/VKCOM/vk-tunnel-client) в качестве туннеля между клиентом и сервером. Автоматически создаёт файл подписки и отправляет его в бакет S3-совместимого объектного хранилища Yandex.Cloud, выдаёт внешнюю ссылку на подписку. С помощью cron каждую минуту следит за работоспособностью туннеля и перезагружает его, если туннель упал. В случае смены домена туннеля, меняет домен в подписке.

Предыдущая версия скрипта заархивирована в [ветке v. 1.0](https://github.com/nebesniy/easy-vk-tunnel/tree/v.-1.0). Тем не менее она может использоваться по назначению для демонстрации работы, в случае если автоматизация не нужна.

**Требования к скрипту:** установленная панель управления ядром xray (Marzban, 3x-ui, Remnawave) или ядро без панели, если вы умеете работать с конфигурацией. Операционная система Debian или Ubuntu.

# Удаление предыдущих версий скрипта

Если ранее вы устанавливали первую версию скрипта, её необходимо удалить:

    rm -rf easy-vk-tunnel

Остановите процесс vk-tunnel, если он выполняется в фоне:

    pkill "vk-tunnel"

Пропустите шаг «подготовка» и переходите сразу к шагу «установка».

# Подготовка

Если вы не устанавливали первую версию скрипта, начните отсюда.

Установите последнюю версию node.js:

    apt-get update && apt-get install npm -y && npm install -g n && n latest

Установите vk-tunnel:

    npm install @vkontakte/vk-tunnel -g

Запустите vk-tunnel и пройдите авторизацию с помощью аккаунта VK:

    vk-tunnel

При первом запуске vk-tunnel выдаст auth-ссылку. Откройте её в браузере и авторизуйтесь с помощью аккаунта VK. После авторизации вернитесь в консоль и нажмите Enter. 

![Первый запуск vk-tunnel](https://i.ibb.co/67m3pdFv/Bildschirmfoto-2025-09-29-um-10-19-42.png?1) 

Vk-tunnel должен выдать два адреса: https:// и wss:// — если это произошло, то вы успешно авторизовались. Ваши данные авторизации он запомнит. Убиваем vk-tunnel нажатием Ctrl+C.

Перейдите в свою панель (Marzban, 3x-ui, Remnawave) или откройте конфиг ядра и создайте новый инбаунд VLESS. Порт выберите **любой** на ваше усмотрение. Транспорт через **WebSockets**. Значение Path (путь) в веб-сокетах можете оставить по умолчанию: «**/**» или впишите произвольную директорию, например «**/hello-world/**». Если вам нужен сниффинг, то можете его включить. Другие настройки не трогайте — оставьте по умолчанию. [Скриншот](https://ibb.co/jPhNwtvc), как это должно выглядеть в панели 3x-ui. 

Или импортируйте инбаунд (здесь UUID «**1b88747a-7184-4d6e-88e3-f888e2664f34**», порт **12345**, путь «**/**», сниффинг **выключен** — отредактируйте в случае необходимости):

    {
      "id": 1,
      "userId": 0,
      "up": 0,
      "down": 0,
      "total": 0,
      "remark": "vk-tunnel",
      "enable": true,
      "expiryTime": 0,
      "listen": "",
      "port": 12345,
      "protocol": "vless",
      "settings": "{\n  \"clients\": [\n    {\n      \"id\": \"1b88747a-7184-4d6e-88e3-f888e2664f34\",\n      \"flow\": \"\",\n      \"email\": \"m4mcjo2c\",\n      \"limitIp\": 0,\n      \"totalGB\": 0,\n      \"expiryTime\": 0,\n      \"enable\": true,\n      \"tgId\": \"\",\n      \"subId\": \"bzn88wh9ioao355m\",\n      \"comment\": \"\",\n      \"reset\": 0\n    }\n  ],\n  \"decryption\": \"none\",\n  \"fallbacks\": []\n}",
      "streamSettings": "{\n  \"network\": \"ws\",\n  \"security\": \"none\",\n  \"externalProxy\": [],\n  \"wsSettings\": {\n    \"acceptProxyProtocol\": false,\n    \"path\": \"/\",\n    \"host\": \"\",\n    \"headers\": {},\n    \"heartbeatPeriod\": 0\n  }\n}",
      "tag": "inbound-12345",
      "sniffing": "{\n  \"enabled\": false,\n  \"destOverride\": [\n    \"http\",\n    \"tls\",\n    \"quic\",\n    \"fakedns\"\n  ],\n  \"metadataOnly\": false,\n  \"routeOnly\": false\n}",
      "clientStats": [
        {
          "id": 1,
          "inboundId": 1,
          "enable": true,
          "email": "vk-tunnel",
          "up": 0,
          "down": 0,
          "expiryTime": 0,
          "total": 0,
          "reset": 0
        }
      ]
    }

# Установка

Для установки вам потребуется завести аккаунт в Yandex.Cloud, создать бакет в объектном хранилище, а также получить идентификатор и ключ статического доступа сервисного аккаунта с ролью **storage.editor**. 

Инструкции от Yandex.Cloud:

 1. [Регистрация аккаунта в Yandex.Cloud](https://yandex.cloud/ru/docs/billing/quickstart/)
 2. [Создание бакета](https://yandex.cloud/ru/docs/storage/operations/buckets/create) — настройки: доступ на чтение объектов **публичный**, доступ к списку объектов **ограниченный**, доступ на чтение настроек **ограниченный**, класс хранилища **стандартное** (на него распространяются лимиты бесплатного использования)
 3. [Создание сервисного аккаунта](https://yandex.cloud/ru/docs/iam/quickstart-sa#create-sa) — настройки: роль в каталоге **storage.editor**, создайте статический ключ доступа и запишите идентификатор и ключ.

Опционально можно предварительно проверить доступ к бакету со своего сервисного аккаунта. К примеру, скачайте [Cyberduck](https://cyberduck.io), тип подключения: **Amazon S3**, сервер: **storage.yandexcloud.net**, порт **443**, Access Key ID: **ваш идентификатор**, Secret Access Key: **ваш ключ**. Если вы видите свой бакет, способны загрузить туда какой-нибудь файл, а потом его удалить, то всё сделано правильно.

Клонируем вторую версию скрипта из репозитория GitHub:

    git clone --single-branch --branch v.-2.0 https://github.com/nebesniy/easy-vk-tunnel.git

Предоставляем скрипту право на исполнение:

    chmod +x easy-vk-tunnel/easy-vk-tunnel.sh

Запускаем установку скрипта:

    ./easy-vk-tunnel/easy-vk-tunnel.sh --install

Скрипт поочерёдно спросит UUID, порт инбаунда и путь инбаунда — согласно вашей конфигурации инбаунда в панели или ядре. Обратите внимание, что UUID это не ID инбаунда, а ID клиента, выглядит он примерно так: «**1b88747a-7184-4d6e-88e3-f888e2664f34**». 

Затем скрипт спросит имя файла подписки — можно оставить по-умолчанию tunnel.txt (оставить пустое поле и нажать Enter) или назвать по-своему. Затем имя созданного вами бакета, идентификатор и ключ созданного вами сервисного аккаунта в Yandex.Cloud.

![Конфигурация скрипта при установке](https://i.ibb.co/pvVrq9Bp/Bildschirmfoto-2025-09-29-um-09-11-21.png)

При успешном завершении установки скрипт выдаст ссылку на файл, размещённый в объектном хранилище. Эту ссылку нужно добавить в ваш VLESS-клиент как подписку. На этом установка завершена.

![Успешное завершение работы](https://i.ibb.co/cK2gw2Xp/Bildschirmfoto-2025-09-29-um-09-12-04.png)

# Дальнейшая логика скрипта

После установки процесс надзора за туннелем и подпиской автоматизирован, для этого в cron добавлено исполнение watchdog-скрипта с запуском каждую минуту. Watchdog проверяет, работает ли туннель. Если туннель перестаёт работать, происходит принудительная перезагрузка туннеля. Если в таком случае туннель выдал новый домен, то формируется новый файл подписки, перезаписывая предыдущий на бакете Yandex.Cloud. Таким образом клиент постоянно получает обновлённую конфигурацию для подключения.

Проверить работу скрипта можно с помощью трансляции из лога:

    tail -f /tmp/easy-vk-tunnel.log

# Устранение неполадок

В случае неверной конфигурации запустите заново установку скрипта:

    ./easy-vk-tunnel/easy-vk-tunnel.sh --install

Рекомендуется на уровне роутинга запретить доступ к доменам *geosite:category-speedtest*, поскольку любой тест скорости рушит туннель. Надзорный скрипт, впрочем, в случае обрушения перезагрузит его автоматически.

Для сброса сессии с VK (повторная авторизация, смена аккаунта), выполните удаление текущей сессии:

    rm ~/.config/configstore/@vkontakte/vk-tunnel.json

Затем заново запустите ```vk-tunnel```, выполните вход путём открытия авторизационной ссылки в браузере и нажмите Enter.

# Удаление скрипта

Удаление скрипта начните с удаления строки ```* * * * * /bin/bash '/root/easy-vk-tunnel/easy-vk-tunnel.sh' --watchdog``` в конфигурации cron:

    crontab -e

Удалите строку через nano, сохраните Ctrl+O, нажмите Enter, выйдите Ctrl+X. Затем удалите директорию со скриптом:

    rm -rf easy-vk-tunnel

# Лицензия

Этот проект распространяется под лицензией CC BY-NC 4.0, запрещающей коммерческое использование. 
